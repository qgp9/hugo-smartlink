{{- /* Merge SmartLink configuration with priority: front matter > site params > defaults */ -}}
{{- $defaultConfig := dict 
    "output" "html"
    "protectcodeblocks" false
    "normalizeescapedwikilink" true
    "maxcodeblockiterations" 50
    "prefixalias" dict
    "rules" slice
    "disable" false
    "supportexts" (slice "md")
    "usepagetitle" false
    "usepagetitleprefixes" (slice)
    "stripnamespaceprefixes" (slice)
-}}
{{- $config := collections.Merge 
    $defaultConfig 
    (site.Params.modules.smartlink | default dict)
    (.Params.smartlink | default dict)
    (.Params.modules.smartlink | default dict)
    (dict)
-}}
{{- $_labelRules := slice -}}
{{- range $k, $v := dict "usePageTitle" $config.usepagetitleprefixes "stripNamespace" $config.stripnamespaceprefixes -}}
    {{- range $v -}}
        {{- $prefix := . -}}
        {{- $body := "{0}" -}}
        {{- if hasPrefix $prefix "-" -}}
            {{- $prefix = strings.TrimPrefix "-" $prefix -}}
            {{- $body = "{1}" -}}
        {{- end -}}
        {{- $_labelRules = $_labelRules | append (dict
            "name" $prefix 
            "prefix" $prefix
            "url" $body 
            "label" $body
            $k true) -}}
    {{- end -}}
{{- end -}}
{{- $_prefixAliasKeys := slice -}}
{{- range $k, $v := $config.prefixalias -}}
    {{- $_prefixAliasKeys = $_prefixAliasKeys | append $k -}}
{{- end -}}
{{- $_aliasRule := slice -}}
{{- range $k, $v := $config.prefixalias -}}
    {{- $_aliasRule = $_aliasRule | append (dict
        "name" $k 
        "prefix" $k 
        "url" (printf "%s{1}" $v) 
        "label" (printf "%s{1}" $v)) -}}
{{- end -}}
{{- $config = merge $config (dict 
    "_prefixaliaskeys" $_prefixAliasKeys 
    "_rulesarray" (slice $_labelRules $_aliasRule $config.rules)
    ) (dict) -}}

{{- .Store.Set "smartlink_config" $config -}}

{{- /* Check if SmartLink is disabled */ -}}
{{- if $config.disable -}}
    {{- .Content | safeHTML -}}
{{- else if not (in $config.supportexts .File.Ext) -}}
    {{- .Content | safeHTML -}}
{{- else if and (ne $config.output "html") (ne $config.output "markdown") -}}
    {{- .Content | safeHTML -}}
{{- else if not (in .Content "[[") -}}
    {{- .Content | safeHTML -}}
{{- else -}}
    {{- $content := "" -}}
    {{- if eq $config.output "html" -}}
        {{- $content = .Content -}}
        
        {{- /* Code block protection */ -}}
        {{- $mapping := slice -}}
        {{- if $config.protectcodeblocks -}}
            {{- $pattern := `(<pre[^>]*>[\s\S]*?</pre>)|(<code[^>]*>[\s\S]*?</code>)` -}}
            
            {{- /* Process nested code blocks */ -}}
            {{- range $i := seq $config.maxcodeblockiterations -}}
                {{- $matches := $content | findRE $pattern | uniq -}}
                {{- if not $matches -}}
                    {{- break -}}
                {{- end -}}
                {{- range $j, $match := $matches -}}
                    {{- $key := len $mapping -}}
                    {{- $mapping = $mapping | append $match -}}
                    {{- $content = replace $content $match (printf "SMARTLINK_PROTECTED_%d" $key) -}}
                {{- end -}}
            {{- end -}}
        {{- end -}}
        
        {{- /* SmartLink processing */ -}}
        {{- $wikilinks := findRE `\[\[[^]]+\]\]` $content | uniq -}}
        {{- range $wikilink := $wikilinks -}}
            {{- if findRE `/\S+?>` $wikilink -}}
                {{- continue -}}
            {{- end -}}
            {{- $link := trim $wikilink "[] " -}}
            {{- if not $link -}}
                {{- continue -}}
            {{- end -}}
            {{- $processed := partialCached "smartlink" (dict "link" $link "config" $config) $link -}}
            {{- $content = replace $content $wikilink $processed -}}
        {{- end -}}
        
        {{- /* Restore code blocks */ -}}
        {{- if $config.protectcodeblocks -}}
            {{- range $i := ($mapping | len | seq 0 | collections.Reverse) -}}
                {{- $content = replace $content (printf "SMARTLINK_PROTECTED_%d" $i) (index $mapping $i ) -}}
            {{- end -}}
        {{- end -}}
    {{- else -}}
        {{- $content = .RenderString (replaceRE `\[\[(\s*[^]\s][^]]*)]]` "{{% smartlink `$1` %}}" .RawContent) -}}
    {{- end -}}

    {{- if $config.normalizeescapedwikilink -}}
        {{- $content = replaceRE `\[\\\[(.*?)]]` "[[$1]]" $content -}}
    {{- end -}}

    {{- $content | safeHTML -}}
    {{/*  DEBUG: {{ $config | jsonify }} EXT: {{ .File.Ext }}  */}}
{{- end -}}
